## ARP协议

### 什么是MAC地址？

MAC地址是链路层地址。又称LAN Address 或Physical address。

- 地址长度6字节。前24位由IEEE分配，后24位由生产商唯一确定避免重复。

### 为什么要用ARP协议？

ARP（Address Resolution Protocol）地址解析协议。

### ARP协议的主要内容

#### 作用：

- 将网络层的32位IP地址转换成链路层的48位地址。

### ARP协议如何执行？

#### ARP工作机制

ARP是借助ARP请求包和ARP响应包来实现IP地址向MAC地址的转换的。

##### 同一条链路内部：

1. 本地主机想要与某一个IP地址的主机进行通信，那么依据ARP协议，本地主机会把目的主机的IP地址塞入ARP请求包内部，然后在同一链路层上进行广播。

2. 同一链路上的主机接受ARP请求包，如果请求包内的目标IP地址与自己的IP地址相同，则将自己的MAC地址塞入ARP响应包，返回给源主机。

##### 不同链路:

我们这里假设一个路由器连接的两个子网，其中一个子网的主机A想要与另一个子网的主机B进行通信。

1. A发送一个ARP协议，其目的MAC地址为路由器连接该子网的端口（注意：路由器的每一个端口都有一个对应的MAC和IP地址）。
2.  路由器检测到A发送来的ARP协议，路由器解包并将数据传送到网络层，依据路由器转发协议（将在其他文章中介绍），找到应该传送的接口，将数据传送给该端口。
3. 该端口将内容封装到一个帧中，发送进其子网内。
4. 响应返回同理可得。

#### 缓存机制

显而易见，每次进行通信的时候都要进行一次ARP包的收发实在是太麻烦了。这些过程中很多是重复的主机间通信，所以自然而然会想到利用缓存来减少消耗，提高性能。

ARP地址缓存表

|    IP地址     |      MAC地址      |    TTL     |
| :-----------: | :---------------: | :--------: |
| 222.222.222.1 | 18-28-9c-10-24-10 | 13：45：00 |

通常做法是，将第一次IP地址对MAC地址映射关系记录表中，下次寻找MAC地址时，先进行查表操作，如果在表中直接返回，否则进行ARP过程。

TTL是期限时间。一方面由于缓存表有限，不能无限存储ARP对应关系。另一方面，更重要的是MAC地址和IP地址的对应关系是经常变动的（MAC地址对应端口，而一个设备的IP是可以轻松更改的，例如一部手机，随着地理位置的移动，它的IP总是更改）。所以需要定期删除和处理缓存表中的对应关系。   



